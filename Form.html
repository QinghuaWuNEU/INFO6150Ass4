<!doctype html>
<html lang="en">
 <head>
  <title>Feedback</title>
  <style>
    label {	float: left;
			width: 150px;}
      #container{
          width: 700px;
          margin: auto;
          background-color: beige;
      } 
      main{
          padding: 50px;
      }
    .error-text {
    	color: red;
        font-size: 0.9em;
        margin-left: 155px; /* 与 label 宽度对齐，使错误信息在输入框下方 */
        display: block; /* 确保它在单独一行 */
    }

    .error-input {
        border: 2px solid red;
    }
  </style>
 </head>
 <body>
 <div id="container">
	 
	 <main>
	 <h2>Feeback</h2>
	 <h3>Love something? Hate something? Let us know!</h3>
		Note : Fields marked with an asterisk(*) are mandatory
		<br><br>
        <form id="feedbackForm" method="post" novalidate>
		 	<label>Title*:</label>
            <span id="titleError" class="error-text" style="display:none;">请选择称谓。</span>
            <input type="radio" name="title" id="miss" value="miss" required="required" onclick="validateForm();"/>Miss
            <input type="radio" name="title" id="mr" value="mr" required="required" onclick="validateForm();"/>Mr.
            <input type="radio" name="title" id="mrs" value="mrs" required="required" onclick="validateForm();"/>Mrs.
            <br><br>
            
            <label for="firstName">First Name*:</label>
            <input type="text" name="firstName" id="firstName" placeholder="First Name" onkeyup="validateField(this, /^[a-zA-Z\s]+$/, 2, 50);" /> 
            <span id="firstNameError" class="error-text" style="display:none;"></span>
            <br><br>
            
            <label for="lastName">Last Name*:</label>
            <input type="text" name="lastName" id="lastName" placeholder="Last Name" onkeyup="validateField(this, /^[a-zA-Z\s]+$/, 2, 50);" />
            <span id="lastNameError" class="error-text" style="display:none;"></span>
            <br><br>
            
            <label for="emailId">Email Id*:</label>
            <input type="text" name="emailId" id="emailId" placeholder="yourname@domain.com" onkeyup="validateField(this, null, 5, 100);" />
            <span id="emailIdError" class="error-text" style="display:none;"></span>
            <br><br>
            
            <label for="phoneNumber">Phone Number*:</label>
            <input type="text" name="phoneNumber" id="phoneNumber" placeholder="xxx-xxx-xxxx" onkeyup="validateField(this, /^[0-9\-\(\)\s]+$/, 10, 15);" />
            <span id="phoneNumberError" class="error-text" style="display:none;"></span>
            <br><br>
            
            <label for="streetAddress2">Street Address 2:</label>
            <input type="text" name="streetAddress2" id="streetAddress2" placeholder="Apt, Suite, etc. (Optional)" onkeyup="validateField(this, /^[a-zA-Z0-9\s\#\-\,]+$/, 0, 50, false);" />
            <span id="streetAddress2Error" class="error-text" style="display:none;"></span>
            <div id="address2Counter" style="margin-left: 155px; font-size: 0.8em; color: gray;">0/50 characters used</div>
            <br><br>
            
            <label for="zipcode">ZipCode*:</label>
            <input type="text" name="zipcode" id="zipcode" placeholder="xxxxxx" onkeyup="validateField(this, /^[0-9]+$/, 5, 10);" />
            <span id="zipcodeError" class="error-text" style="display:none;"></span>
            <br><br>
              
            <label for="source">How did you hear*:</label>
            <input type='checkbox' name="source" value="facebook" onclick="validateForm();" /> Facebook
            <input type='checkbox' name="source" value="google" onclick="validateForm();" /> Google
            <input type='checkbox' name="source" value="yelp" onclick="validateForm();" /> Yelp 
            <span id="sourceError" class="error-text" style="display:none;">请至少选择一个来源。</span>
            <br><br> 

            <label for="comments">Comments*:</label>
            <textarea name="text" id="comments" placeholder="Your comments" rows="5" cols="25" onkeyup="validateField(this, null, 10, 500);"></textarea>
            <span id="commentsError" class="error-text" style="display:none;"></span>
            <br><br>

            <input type="Submit" id="submitButton" disabled>
            <input type="Reset">
            <br><br>
		 </form>
	 </main>
 </div>

 <script>
 
    // 存储上一次提交的数据
    var previousSubmissions = [];

    // =========================================================================
    // 电话号码输入掩码 (Input Masking)
    // =========================================================================

    /**
     * 实时格式化电话号码并验证 (要求 1 - 附加功能, 要求 4)
     * 格式: (XXX) XXX-XXXX
     */
    function phoneMaskAndValidate(field) {
        let input = field.value.replace(/\D/g, ''); // 仅保留数字

        // 格式化逻辑
        let formattedInput = '';
        if (input.length > 0) {
            formattedInput += '(' + input.substring(0, 3);
        }
        if (input.length >= 4) {
            formattedInput += ') ' + input.substring(3, 6);
        }
        if (input.length >= 7) {
            formattedInput += '-' + input.substring(6, 10);
        }

        field.value = formattedInput;
        
        // 调用通用验证函数进行最终验证 (要求 4)
        // 期望格式为: (123) 456-7890 (长度为 14)
        const phoneRegex = /^\(\d{3}\) \d{3}\-\d{4}$/; 
        validateField(field, phoneRegex, 14, 14); 

        // 如果用户在输入，但尚未达到完整长度，则不显示错误（即使 validateField 可能会设置错误）
        if (input.length < 10) {
            const errorElement = document.getElementById('phoneNumberError');
            errorElement.style.display = 'none';
            field.classList.remove('error-input');
        }
        
        // 重新调用 validateForm 来检查提交按钮状态
        validateForm();
    }


    // =========================================================================
    // 动态下拉列表和复选框逻辑 (要求 6, 7, 8, 9)
    // =========================================================================

    /**
     * 处理 Reason for Feedback 下拉列表的 onChange 事件 (要求 7, 8)
     */
    function handleReasonChange(selectElement) {
        const selectedValue = selectElement.value;
        const container = document.getElementById('dynamicContentArea');
        
        // 1. 移除所有旧的动态内容
        container.innerHTML = '';
        
        // 2. 只有在选择了有效值时才添加复选框 (要求 8)
        if (selectedValue !== "") {
            const labelText = `Enable specific settings for ${selectedValue}?`;
            const checkboxHtml = `
                <label></label>
                <input type="checkbox" id="dynamicCheckbox" name="dynamicCheckbox" 
                       onclick="handleCheckboxToggle(this, '${selectedValue}'); validateForm();"/> 
                ${labelText}
                <br><br>
            `;
            container.innerHTML = checkboxHtml;
        }

        // 3. 验证 Reason Select 自身
        validateSelect(selectElement);
        
        // 4. 更新表单状态
        validateForm();
    }

    /**
     * 处理动态生成的复选框的 onClick 事件 (要求 9)
     */
    function handleCheckboxToggle(checkbox, reason) {
        const container = document.getElementById('dynamicContentArea');
        const existingTextDiv = document.getElementById('dynamicTextFieldDiv');

        if (checkbox.checked) {
            // 如果选中，添加必填文本字段
            const textFieldHtml = `
                <div id="dynamicTextFieldDiv">
                    <label for="dynamicTextField">Additional detail for ${reason}*:</label>
                    <input type="text" id="dynamicTextField" name="dynamicTextField" 
                           placeholder="Enter mandatory detail"
                           onkeyup="validateDynamicField(this, 5, 100);" />
                    <span id="dynamicTextFieldError" class="error-text" style="display:none;"></span>
                    <br><br>
                </div>
            `;
            // 将新的 Div 附加到现有复选框之后
            container.insertAdjacentHTML('beforeend', textFieldHtml);
        } else {
            // 如果未选中，移除文本字段
            if (existingTextDiv) {
                existingTextDiv.remove();
            }
        }
        
        // 重新检查表单以禁用/启用提交按钮 (确保在字段添加/移除时状态正确)
        validateForm();
    }
    
    /**
     * 验证动态生成的必填文本字段
     */
    function validateDynamicField(field, minLen, maxLen) {
        // 使用一个简化的 validateField 版本，只检查非空、长度和错误高亮
        const value = field.value.trim();
        const errorElement = document.getElementById('dynamicTextFieldError');
        let isValid = true;
        let errorMessage = '';

        if (value.length === 0) {
            isValid = false;
            errorMessage = field.placeholder + ' 不能为空。';
        } else if (value.length < minLen) {
            isValid = false;
            errorMessage = '至少需要 ' + minLen + ' 个字符。';
        } else if (value.length > maxLen) {
            isValid = false;
            errorMessage = '最多只能有 ' + maxLen + ' 个字符。';
        }

        if (isValid) {
            errorElement.style.display = 'none';
            field.classList.remove('error-input');
        } else {
            errorElement.style.display = 'block';
            errorElement.textContent = errorMessage;
            field.classList.add('error-input');
        }
        
        validateForm();
    }
    
    /**
     * 验证 Reason Select 列表 (要求 6)
     */
    function validateSelect(selectElement) {
        const errorElement = document.getElementById('reasonSelectError');
        let isValid = selectElement.value !== "";
        
        if (isValid) {
             errorElement.style.display = 'none';
             selectElement.classList.remove('error-input');
        } else {
             errorElement.style.display = 'block';
             errorElement.textContent = '请选择一个反馈原因。';
             selectElement.classList.add('error-input');
        }
        return isValid;
    }

    // =========================================================================
    // 验证逻辑 (要求 2, 3, 5, 13)
    // =========================================================================

    /**
     * 通用字段验证函数。
     * @param {HTMLElement} field - 当前输入元素 (input/textarea)。
     * @param {RegExp} regex - 用于检查字符的正则表达式 (对于纯文本/数字字段)。
     * @param {number} minLen - 最小长度要求。
     * @param {number} maxLen - 最大长度要求。
     * @param {boolean} isRequired - 字段是否为强制性的 (默认为 true)。
     */
    function validateField(field, regex, minLen, maxLen, isRequired = true) {
        const value = field.value.trim();
        const errorElement = document.getElementById(field.id + 'Error');
        let isValid = true;
        let errorMessage = '';

        // 特殊字段验证 - 优先级高于通用检查，因为它可能使用不同的 regex
        if (field.id === 'emailId') {
            // 要求 4 & 12: 邮箱必须是 @northeastern.edu 域
            const emailRegex = /^[a-zA-Z0-9._%+-]+@northeastern\.edu$/;
            
            if (isRequired && value.length === 0) {
                isValid = false;
                errorMessage = 'Email Id 不能为空。';
            } else if (!emailRegex.test(value) && value.length > 0) {
                isValid = false;
                errorMessage = 'Email 格式错误或必须使用 @northeastern.edu 域。';
            } else if (value.length > maxLen) {
                 isValid = false;
                 errorMessage = '最多只能有 ' + maxLen + ' 个字符。';
            }
        } 
        else if (field.id === 'zipcode') {
            // 要求 4: 邮编必须是 5 位数字
            const zipRegex = /^\d{5}$/;
            
            if (isRequired && value.length === 0) {
                isValid = false;
                errorMessage = 'ZipCode 不能为空。';
            } else if (!zipRegex.test(value) && value.length > 0) {
                isValid = false;
                errorMessage = 'ZipCode 必须是 5 位数字。';
            }
        }

        // 1. 必填字段非空检查 (要求 2a)
        if (isRequired && value.length === 0) {
            isValid = false;
            errorMessage = field.placeholder + ' 不能为空。';
        } 
        
        // 2. 长度检查 (要求 2b & 2c)
        else if (isRequired && value.length < minLen) {
            isValid = false;
            errorMessage = '至少需要 ' + minLen + ' 个字符。';
        } else if (value.length > maxLen) {
            isValid = false;
            errorMessage = '最多只能有 ' + maxLen + ' 个字符。';
        }
        
        // 3. 字符类型检查 (要求 2d)
        else if (regex && !regex.test(value) && value.length > 0) {
            isValid = false;
            // 为不同的字段提供更具体的错误信息
            if (field.id === 'firstName' || field.id === 'lastName') {
                 errorMessage = '姓名只能包含字母和空格。';
            } else if (field.id === 'phoneNumber') {
                 errorMessage = '电话号码只能包含数字、-、()和空格。';
            } else if (field.id === 'zipcode') {
                 errorMessage = '邮编只能包含数字。';
            } else if (field.id === 'streetAddress2') {
                 errorMessage = '地址只能包含字母、数字、#、-、, 和空格。';
            } else {
                 errorMessage = '该字段包含不允许的特殊字符。';
            }
        }
        
        // 4. 特殊情况处理：Street Address 2 (非必填)
        if (field.id === 'streetAddress2') {
            // 实时字符计数器 (要求 3 - 附加功能)
            const counter = document.getElementById('address2Counter');
            counter.textContent = value.length + '/' + maxLen + ' characters used';
            
            // 如果非必填字段为空，不显示错误
            if (!isRequired && value.length === 0) {
                 isValid = true;
                 errorMessage = '';
            }
            // 如果用户输入了内容，则检查其格式和长度
            if (value.length > 0) {
                 // 重新检查长度和字符
                 if (value.length < minLen) {
                    isValid = false;
                    errorMessage = '至少需要 ' + minLen + ' 个字符。';
                 } else if (regex && !regex.test(value)) {
                    isValid = false;
                    errorMessage = '地址只能包含字母、数字、#、-、, 和空格。';
                 }
            }
        }
        
        // 动态错误高亮 (要求 3 - 附加功能)
        if (isValid) {
            errorElement.style.display = 'none';
            errorElement.textContent = '';
            field.classList.remove('error-input');
        } else {
            errorElement.style.display = 'block';
            errorElement.textContent = errorMessage;
            field.classList.add('error-input');
        }

        // 验证完成后，检查整个表单状态以决定是否启用提交按钮
        validateForm();
    }

    /**
     * 检查表单中所有必填字段的总体状态，以启用/禁用提交按钮 (要求 3)。
     */
    function validateForm() {
        const form = document.getElementById('feedbackForm');
        const submitButton = document.getElementById('submitButton');
        let isFormValid = true;

        // 获取所有带有 onkeyup 事件的必填输入字段
        const requiredFields = [
            'firstName', 'lastName', 'emailId', 'phoneNumber', 'zipcode', 'comments'
        ];

        // 检查所有必填文本/文本域字段
        requiredFields.forEach(id => {
            const field = document.getElementById(id);
            // 检查字段是否为空 (要求 2a) 或是否被标记为错误 (要求 2d, 2b, 2c)
            // 注意：我们依赖 onkeyup 中的 validateField 已经设置了 'error-input' 类
            if (!field || field.value.trim() === '' || field.classList.contains('error-input')) {
                isFormValid = false;
            }
        });

        // 特殊检查 1: 称谓 (Radio Buttons)
        const titleRadios = form.elements['title'];
        let isTitleChecked = Array.from(titleRadios).some(radio => radio.checked);
        if (!isTitleChecked) {
            isFormValid = false;
            document.getElementById('titleError').style.display = 'block';
        } else {
            document.getElementById('titleError').style.display = 'none';
        }

        // 特殊检查 2: How did you hear (Checkboxes)
        const sourceCheckboxes = form.elements['source'];
        let isSourceChecked = Array.from(sourceCheckboxes).some(checkbox => checkbox.checked);
        if (!isSourceChecked) {
            isFormValid = false;
            document.getElementById('sourceError').style.display = 'block';
        } else {
            document.getElementById('sourceError').style.display = 'none';
        }
        
        // 4. 特殊检查 3: Reason Select (下拉列表)
        const reasonSelect = document.getElementById('reasonSelect');
        if (reasonSelect && !validateSelect(reasonSelect)) {
            isFormValid = false;
        }

        // 5. 特殊检查 4: 动态生成的必填文本字段 (要求 9)
        const dynamicCheckbox = document.getElementById('dynamicCheckbox');
        const dynamicTextField = document.getElementById('dynamicTextField');
        
        if (dynamicCheckbox && dynamicCheckbox.checked) {
            // 如果复选框被选中，则文本字段必须存在且有效
            if (!dynamicTextField || dynamicTextField.value.trim() === '' || dynamicTextField.classList.contains('error-input')) {
                isFormValid = false;
            }
        }

        // 最终决定提交按钮的状态
        submitButton.disabled = !isFormValid;
    }

    // =========================================================================
    // 提交和初始化逻辑
    // =========================================================================
    
    /**
     * 清空表单字段 (要求 11)
     */
     function clearFormFields(form) {
        form.reset(); 
        
        // 手动清除错误高亮和动态内容
        document.querySelectorAll('.error-input').forEach(el => el.classList.remove('error-input'));
        document.querySelectorAll('.error-text').forEach(el => el.style.display = 'none');
        document.getElementById('dynamicContentArea').innerHTML = '';
        
        // 重置 Street Address 2 计数器
        document.getElementById('address2Counter').textContent = '0/50 characters used';
        
        // 确保提交按钮被禁用
        document.getElementById('submitButton').disabled = true;

        // 重新运行验证来清理所有状态
        validateForm(); 
    }

    /**
     * 处理表单提交 (要求 10, 11)
     */
    document.getElementById('feedbackForm').onsubmit = function(event) {
        event.preventDefault(); // 阻止默认提交行为
        
        const form = event.target;
        
        // 1. 验证最终状态
        validateForm();
        if (form.elements['submitButton'].disabled) {
            alert('请填写所有必填字段并修正错误。');
            return; 
        }

        // 2. 收集数据
        const data = {};
        const elements = form.elements;
        
        for (let i = 0; i < elements.length; i++) {
            const element = elements[i];
            const name = element.name;
            
            if (name) {
                if (element.type === 'radio' || element.type === 'checkbox') {
                    if (element.checked) {
                        if (data[name]) {
                            // 处理多个复选框
                            if (Array.isArray(data[name])) {
                                data[name].push(element.value);
                            } else {
                                data[name] = [data[name], element.value];
                            }
                        } else {
                            data[name] = element.value;
                        }
                    }
                } else if (element.tagName === 'SELECT') {
                    data[name] = element.value;
                } else if (element.type !== 'submit' && element.type !== 'reset') {
                    data[name] = element.value.trim();
                }
            }
        }
        
        // 捕获动态字段的值
        data['reasonSelect'] = form.querySelector('#reasonSelect').value;
        const dynamicCheckbox = document.getElementById('dynamicCheckbox');
        const dynamicTextField = document.getElementById('dynamicTextField');
        if (dynamicCheckbox) {
             data['dynamicCheckbox'] = dynamicCheckbox.checked ? 'Yes' : 'No';
             data['dynamicTextField'] = dynamicTextField ? dynamicTextField.value.trim() : 'N/A';
        } else {
             data['dynamicCheckbox'] = 'N/A';
             data['dynamicTextField'] = 'N/A';
        }
        
        // 要求 13: Street address 2 非强制，如果为空则保持为空
        data['streetAddress2'] = data['streetAddress2'] || '';


        // 3. 存储数据 (要求 10 - 捕获之前的数据)
        previousSubmissions.push(data);
        
        // 4. 显示 HTML Table (要求 10)
        displayResultsTable(previousSubmissions);
        
        // 5. 清空表单 (要求 11)
        clearFormFields(form);
    };

    /**
     * 创建并显示结果表格 (要求 10)
     */
    function displayResultsTable(submissions) {
        if (submissions.length === 0) return;

        let tableHtml = '<h3>Previous Submissions</h3>';
        
        // 获取所有键名作为表头 (确保包含所有可能的字段)
        const allKeys = new Set();
        submissions.forEach(sub => {
            Object.keys(sub).forEach(key => allKeys.add(key));
        });
        const headers = Array.from(allKeys).sort(); // 排序以便一致性

        tableHtml += '<table border="1" style="width:100%; border-collapse: collapse;">';
        
        // 表头
        tableHtml += '<tr>';
        headers.forEach(key => {
            // 格式化表头名称，使其更具可读性
            const displayKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            tableHtml += `<th style="padding: 5px;">${displayKey}</th>`;
        });
        tableHtml += '</tr>';

        // 行数据
        submissions.forEach((sub, index) => {
            tableHtml += `<tr style="background-color: ${index % 2 === 0 ? '#f2f2f2' : 'white'};">`;
            headers.forEach(key => {
                let value = sub[key] !== undefined ? sub[key] : 'N/A';
                
                // 处理数组值 (如 How did you hear)
                if (Array.isArray(value)) {
                    value = value.join(', ');
                }
                
                tableHtml += `<td style="padding: 5px; word-break: break-word;">${value}</td>`;
            });
            tableHtml += '</tr>';
        });

        tableHtml += '</table>';

        document.getElementById('resultsTableContainer').innerHTML = tableHtml;
    }

    // 页面加载时，对所有字段执行初始验证，以确保按钮初始状态正确
    document.addEventListener('DOMContentLoaded', function() {
        // 页面加载后立即禁用提交按钮
        document.getElementById('submitButton').disabled = true;

        // 首次加载时，对所有字段执行一次完整的验证（主要为了设置按钮状态）
        // 避免在DOM上直接写太复杂的onkeyup逻辑，这里模拟触发验证。
        const fieldsToInit = ['firstName', 'lastName', 'emailId', 'phoneNumber', 'zipcode', 'comments', 'reasonSelect'];
        fieldsToInit.forEach(id => {
            const field = document.getElementById(id);
            if (field) {
                if (field.id === 'phoneNumber') {
                    phoneMaskAndValidate(field); // 触发电话掩码/验证
                } else if (field.id === 'reasonSelect') {
                    validateSelect(field); // 触发下拉列表验证
                } else {
                    // 触发通用验证
                    validateField(field, field.getAttribute('onkeyup').match(/\/(.*?)\//) ? new RegExp(field.getAttribute('onkeyup').match(/\/(.*?)\//)[1]) : null, 
                              field.getAttribute('onkeyup').match(/\d+/g) ? parseInt(field.getAttribute('onkeyup').match(/\d+/g)[0]) : 0, 
                              field.getAttribute('onkeyup').match(/\d+/g) ? parseInt(field.getAttribute('onkeyup').match(/\d+/g)[1]) : 0);
                }
            }
        });
        
        // 触发一次 validateForm 来设置按钮状态
        validateForm();
    });
 </script>

 </body>
</html>

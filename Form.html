<!doctype html>
<html lang="en">
 <head>
  <title>Feedback</title>
  <style>
    /* 基础样式 - 保持不变 */
    label {	float: left;
			width: 150px;}
      #container{
          width: 700px;
          margin: auto;
          background-color: beige;
      } 
      main{
          padding: 50px;
      }
    .error-text {
    	color: red;
        font-size: 0.9em;
        margin-left: 155px; /* Aligned with label width */
        display: block;
    }

    .error-input {
        border: 2px solid red;
    }

    /* AI Assistant Styles */
    #aiAssistantButton {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        background-color: #0055A5; /* Northeastern Blue */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
    }

    #chatWindow {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        height: 400px;
        background-color: white;
        border: 1px solid #ccc;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        display: none; /* Hidden by default */
        flex-direction: column;
        z-index: 1001;
        border-radius: 8px;
        overflow: hidden;
    }

    #chatHeader {
        background-color: #0055A5;
        color: white;
        padding: 10px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #chatHeader button {
        background: none;
        border: none;
        color: white;
        font-size: 1.2em;
        cursor: pointer;
    }

    #chatMessages {
        flex-grow: 1;
        padding: 10px;
        overflow-y: auto;
        border-bottom: 1px solid #eee;
    }

    .user-message {
        text-align: right;
        margin-bottom: 5px;
    }
    .user-message p {
        background-color: #e0f7fa;
        display: inline-block;
        padding: 8px;
        border-radius: 10px 10px 0 10px;
        max-width: 80%;
        margin: 0;
    }

    .assistant-message {
        text-align: left;
        margin-bottom: 5px;
    }
    .assistant-message p {
        background-color: #f1f0f0;
        display: inline-block;
        padding: 8px;
        border-radius: 10px 10px 10px 0;
        max-width: 80%;
        margin: 0;
    }

    #chatInputArea {
        display: flex;
        padding: 10px;
        border-top: 1px solid #eee;
    }
    #chatInput {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-right: 5px;
    }
    #sendButton {
        padding: 8px 12px;
        background-color: #0055A5;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

  </style>
 </head>
 <body>
 <button id="aiAssistantButton" onclick="toggleChatWindow()">AI Assistant</button>
 
 <div id="chatWindow">
     <div id="chatHeader">
         AI Assistant (FAQ)
         <button onclick="toggleChatWindow()">X</button>
     </div>
     <div id="chatMessages">
         <div class="assistant-message"><p>Hi! Ask me any question about this form.</p></div>
     </div>
     <div id="chatInputArea">
         <input type="text" id="chatInput" placeholder="Ask a question..." onkeydown="handleChatInput(event)">
         <button id="sendButton" onclick="sendChatMessage()">Send</button>
     </div>
 </div>

 <div id="container">
	 
	 <main>
	 <h2>Feeback</h2>
	 <h3>Love something? Hate something? Let us know!</h3>
		Note : Fields marked with an asterisk(*) are mandatory
		<br><br>
        <form id="feedbackForm" method="post" novalidate>
		 	<label>Title*:</label>
            <span id="titleError" class="error-text" style="display:none;">Please select a title.</span>
            <input type="radio" name="title" id="miss" value="miss" required="required" onclick="validateForm();"/>Miss
            <input type="radio" name="title" id="mr" value="mr" required="required" onclick="validateForm();"/>Mr.
            <input type="radio" name="title" id="mrs" value="mrs" required="required" onclick="validateForm();"/>Mrs.
            <br><br>
            
            <label for="firstName">First Name*:</label>
            <input type="text" name="firstName" id="firstName" placeholder="First Name" onkeyup="validateField(this, /^[a-zA-Z\s]+$/, 2, 50);" /> 
            <span id="firstNameError" class="error-text" style="display:none;"></span>
            <br><br>
            
            <label for="lastName">Last Name*:</label>
            <input type="text" name="lastName" id="lastName" placeholder="Last Name" onkeyup="validateField(this, /^[a-zA-Z\s]+$/, 2, 50);" />
            <span id="lastNameError" class="error-text" style="display:none;"></span>
            <br><br>
            
            <label for="emailId">Email Id*:</label>
            <input type="text" name="emailId" id="emailId" placeholder="yourname@northeastern.edu" onkeyup="validateField(this, null, 5, 100);" /> 
            <span id="emailIdError" class="error-text" style="display:none;"></span>
            <br><br>
            
            <label for="phoneNumber">Phone Number*:</label>
            <input type="text" name="phoneNumber" id="phoneNumber" placeholder="(XXX) XXX-XXXX" onkeyup="phoneMaskAndValidate(this);" maxlength="14" />
            <span id="phoneNumberError" class="error-text" style="display:none;"></span>
            <br><br>
            
            <label for="streetAddress2">Street Address 2:</label>
            <input type="text" name="streetAddress2" id="streetAddress2" placeholder="Apt, Suite, etc. (Optional)" onkeyup="validateField(this, /^[a-zA-Z0-9\s\#\-\,]+$/, 0, 50, false);" />
            <span id="streetAddress2Error" class="error-text" style="display:none;"></span>
            <div id="address2Counter" style="margin-left: 155px; font-size: 0.8em; color: gray;">0/50 characters used</div>
            <br><br>
            
            <label for="zipcode">ZipCode*:</label>
            <input type="text" name="zipcode" id="zipcode" placeholder="xxxxx" onkeyup="validateField(this, null, 5, 5);" maxlength="5" />
            <span id="zipcodeError" class="error-text" style="display:none;"></span>
            <br><br>
              
            <label for="source">How did you hear*:</label>
            <input type='checkbox' name="source" value="facebook" onclick="validateForm();" /> Facebook
            <input type='checkbox' name="source" value="google" onclick="validateForm();" /> Google
            <input type='checkbox' name="source" value="yelp" onclick="validateForm();" /> Yelp 
            <span id="sourceError" class="error-text" style="display:none;">Please select at least one source.</span>
            <br><br> 

            <label for="reasonSelect">Reason for Feedback*:</label>
            <select id="reasonSelect" onchange="handleReasonChange(this);">
                <option value="" disabled selected>-- Select a reason --</option>
                <option value="Product">Product Issue</option>
                <option value="Service">Service Complaint</option>
                <option value="Suggestion">Feature Suggestion</option>
                <option value="Website">Website Bug</option>
                <option value="Other">Other</option>
            </select>
            <span id="reasonSelectError" class="error-text" style="display:none;">Please select a reason for feedback.</span>
            <br><br>

            <div id="dynamicContentArea">
            </div>


            <label for="comments">Comments*:</label>
            <textarea name="text" id="comments" placeholder="Your comments" rows="5" cols="25" onkeyup="validateField(this, null, 10, 500);"></textarea>
            <span id="commentsError" class="error-text" style="display:none;"></span>
            <br><br>

            <input type="Submit" id="submitButton" value="Submit" disabled>
            <input type="Reset" value="Reset">
            <br><br>
		 </form>
         
         <div id="resultsTableContainer"></div>
	 </main>
 </div>

 <script>
 
    // 存储上一次提交的数据
    var previousSubmissions = [];

    // =========================================================================
    // AI Assistant 逻辑 (要求 4)
    // =========================================================================
    
    // 预定义的 FAQ 问答库 (英文关键词和回复)
    const faqData = [
        { 
            keywords: ['email', 'mail', 'northeastern', 'use', 'what email'], 
            answer: 'You must use your Northeastern email (example: student@northeastern.edu).' 
        },
        { 
            keywords: ['phone', 'number', 'format', 'what format'], 
            answer: 'The phone number must be in the format (XXX) XXX-XXXX.' 
        },
        { 
            keywords: ['zip', 'code', 'digits', 'how many'], 
            answer: 'The zip code must be exactly 5 digits.' 
        },
        { 
            keywords: ['required', 'mandatory', 'must', 'fields', 'what fields'], 
            answer: 'All fields are required except Street Address 2.' 
        },
        { 
            keywords: ['address 2', 'street address 2', 'optional', 'mandatory'], 
            answer: 'No, Street Address 2 is optional. If left blank, it will remain empty in the results table.' 
        }
    ];

    /**
     * 切换聊天窗口的显示状态 
     */
    function toggleChatWindow() {
        const chatWindow = document.getElementById('chatWindow');
        chatWindow.style.display = (chatWindow.style.display === 'flex') ? 'none' : 'flex';
    }

    /**
     * 处理输入框的回车键 (Key Event)
     */
    function handleChatInput(event) {
        if (event.key === 'Enter') {
            sendChatMessage();
        }
    }

    /**
     * 发送用户消息并获取 AI 回复
     */
    function sendChatMessage() {
        const inputField = document.getElementById('chatInput');
        const userQuestion = inputField.value.trim();

        if (userQuestion === '') return;

        // 1. 显示用户消息
        appendMessage(userQuestion, 'user');
        inputField.value = ''; // 清空输入框

        // 2. 查找匹配的 FAQ
        const lowerQuestion = userQuestion.toLowerCase();
        let assistantReply = 'Sorry, I don’t know that yet. Please check the instructions.'; // 默认回复

        // 遍历 FAQ 库，寻找关键词匹配
        for (const faq of faqData) {
            if (faq.keywords.some(keyword => lowerQuestion.includes(keyword))) {
                assistantReply = faq.answer;
                break;
            }
        }

        // 3. 显示 AI 回复 (异步模拟延迟)
        setTimeout(() => {
            appendMessage(assistantReply, 'assistant');
        }, 500); 
        
    }

    /**
     * 将消息添加到聊天记录
     */
    function appendMessage(text, sender) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'user' ? 'user-message' : 'assistant-message';
        messageDiv.innerHTML = `<p>${text}</p>`;
        
        chatMessages.appendChild(messageDiv);
        
        // 自动滚动到最新消息
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    // =========================================================================
    // 电话号码输入掩码 (Input Masking)
    // =========================================================================
    
    /**
     * 实时格式化电话号码并验证 (格式: (XXX) XXX-XXXX)
     */
    function phoneMaskAndValidate(field) {
        let input = field.value.replace(/\D/g, ''); 
        let formattedInput = '';

        if (input.length > 0) {
            formattedInput += '(' + input.substring(0, 3);
        }
        if (input.length >= 4) {
            formattedInput += ') ' + input.substring(3, 6);
        }
        if (input.length >= 7) {
            formattedInput += '-' + input.substring(6, 10);
        }

        field.value = formattedInput;
        
        // 调用通用验证函数进行最终验证
        const phoneRegex = /^\(\d{3}\) \d{3}\-\d{4}$/; 
        validateField(field, phoneRegex, 14, 14); 

        // 确保未完成输入时不会显示错误
        if (input.length < 10) {
            const errorElement = document.getElementById('phoneNumberError');
            errorElement.style.display = 'none';
            field.classList.remove('error-input');
        }
        
        validateForm();
    }


    // =========================================================================
    // 动态下拉列表和复选框逻辑 (要求 6, 7, 8, 9)
    // =========================================================================

    /**
     * 处理 Reason for Feedback 下拉列表的 onChange 事件 (触发要求 7, 8)
     */
    function handleReasonChange(selectElement) {
        const selectedValue = selectElement.value;
        const container = document.getElementById('dynamicContentArea');
        
        // 1. 移除所有旧的动态内容
        container.innerHTML = '';
        
        // 2. 只有在选择了有效值时才添加复选框 (要求 8)
        if (selectedValue !== "") {
            const labelText = `Enable specific settings for ${selectedValue}?`;
            const checkboxHtml = `
                <label></label>
                <input type="checkbox" id="dynamicCheckbox" name="dynamicCheckbox" 
                       onclick="handleCheckboxToggle(this, '${selectedValue}'); validateForm();"/> 
                ${labelText}
                <br><br>
            `;
            container.innerHTML = checkboxHtml;
        }

        // 3. 验证 Reason Select 自身
        validateSelect(selectElement);
        
        // 4. 更新表单状态
        validateForm();
    }

    /**
     * 处理动态生成的复选框的 onClick 事件 (触发要求 9)
     */
    function handleCheckboxToggle(checkbox, reason) {
        const container = document.getElementById('dynamicContentArea');
        const existingTextDiv = document.getElementById('dynamicTextFieldDiv');

        if (checkbox.checked) {
            // 如果选中，添加必填文本字段
            const textFieldHtml = `
                <div id="dynamicTextFieldDiv">
                    <label for="dynamicTextField">Additional detail for ${reason}*:</label>
                    <input type="text" id="dynamicTextField" name="dynamicTextField" 
                           placeholder="Enter mandatory detail"
                           onkeyup="validateDynamicField(this, 5, 100);" />
                    <span id="dynamicTextFieldError" class="error-text" style="display:none;"></span>
                    <br><br>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', textFieldHtml);
        } else {
            // 如果未选中，移除文本字段
            if (existingTextDiv) {
                existingTextDiv.remove();
            }
        }
        
        validateForm();
    }
    
    /**
     * 验证动态生成的必填文本字段
     */
    function validateDynamicField(field, minLen, maxLen) {
        const value = field.value.trim();
        const errorElement = document.getElementById('dynamicTextFieldError');
        let isValid = true;
        let errorMessage = '';

        if (value.length === 0) {
            isValid = false;
            errorMessage = field.placeholder + ' cannot be empty.';
        } else if (value.length < minLen) {
            isValid = false;
            errorMessage = 'Requires at least ' + minLen + ' characters.';
        } else if (value.length > maxLen) {
            isValid = false;
            errorMessage = 'Can have a maximum of ' + maxLen + ' characters.';
        }

        if (isValid) {
            errorElement.style.display = 'none';
            field.classList.remove('error-input');
        } else {
            errorElement.style.display = 'block';
            errorElement.textContent = errorMessage;
            field.classList.add('error-input');
        }
        
        validateForm();
    }
    
    /**
     * 验证 Reason Select 列表 
     */
    function validateSelect(selectElement) {
        const errorElement = document.getElementById('reasonSelectError');
        let isValid = selectElement.value !== "";
        
        if (isValid) {
             errorElement.style.display = 'none';
             selectElement.classList.remove('error-input');
        } else {
             errorElement.style.display = 'block';
             errorElement.textContent = 'Please select a reason for feedback.';
             selectElement.classList.add('error-input');
        }
        return isValid;
    }


    // =========================================================================
    // 核心验证逻辑 (包含要求 2, 4, 12, 13)
    // =========================================================================

    /**
     * 通用字段验证函数。
     */
    function validateField(field, regex, minLen, maxLen, isRequired = true) {
        const value = field.value.trim();
        const errorElement = document.getElementById(field.id + 'Error');
        let isValid = true;
        let errorMessage = '';

        // 特殊字段验证 - 邮箱 (要求 12)
        if (field.id === 'emailId') {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@northeastern\.edu$/;
            
            if (isRequired && value.length === 0) {
                isValid = false;
                errorMessage = 'Email Id cannot be empty.';
            } else if (!emailRegex.test(value) && value.length > 0) {
                isValid = false;
                errorMessage = 'Email format is invalid or must use @northeastern.edu domain.';
            } else if (value.length > maxLen) {
                 isValid = false;
                 errorMessage = 'Can have a maximum of ' + maxLen + ' characters.';
            }
        } 
        // 特殊字段验证 - 邮编 (要求 4, 12)
        else if (field.id === 'zipcode') {
            const zipRegex = /^\d{5}$/;
            
            if (isRequired && value.length === 0) {
                isValid = false;
                errorMessage = 'ZipCode cannot be empty.';
            } else if (!zipRegex.test(value) && value.length > 0) {
                isValid = false;
                errorMessage = 'ZipCode must be exactly 5 digits.';
            }
        }
        
        // 1. 必填字段非空检查
        else if (isRequired && value.length === 0) {
            isValid = false;
            errorMessage = field.placeholder + ' cannot be empty.';
        } 
        
        // 2. 长度检查
        else if (isRequired && value.length < minLen) {
            isValid = false;
            errorMessage = 'Requires at least ' + minLen + ' characters.';
        } else if (value.length > maxLen) {
            isValid = false;
            errorMessage = 'Can have a maximum of ' + maxLen + ' characters.';
        }
        
        // 3. 字符类型检查
        else if (regex && !regex.test(value) && value.length > 0) {
            isValid = false;
            if (field.id === 'firstName' || field.id === 'lastName') {
                 errorMessage = 'Name can only contain letters and spaces.';
            } else if (field.id === 'streetAddress2') {
                 errorMessage = 'Address can only contain letters, numbers, #, -, , and spaces.';
            } else {
                 errorMessage = 'This field contains disallowed special characters.';
            }
        }
        
        // 4. Street Address 2 (非必填) 和字符计数
        if (field.id === 'streetAddress2') {
            const counter = document.getElementById('address2Counter');
            counter.textContent = value.length + '/' + maxLen + ' characters used';
            
            if (!isRequired && value.length === 0) {
                 isValid = true;
                 errorMessage = '';
            }
            else if (value.length > 0 && !isValid) { 
                 if (value.length < minLen) {
                    isValid = false;
                    errorMessage = 'Requires at least ' + minLen + ' characters.';
                 } else if (regex && !regex.test(value)) {
                    isValid = false;
                    errorMessage = 'Address can only contain letters, numbers, #, -, , and spaces.';
                 }
            }
        }
        
        // 动态错误高亮
        if (isValid) {
            errorElement.style.display = 'none';
            errorElement.textContent = '';
            field.classList.remove('error-input');
        } else {
            errorElement.style.display = 'block';
            errorElement.textContent = errorMessage;
            field.classList.add('error-input');
        }

        validateForm();
    }

    /**
     * 检查表单中所有必填字段的总体状态，以启用/禁用提交按钮 (要求 3)。
     */
    function validateForm() {
        const form = document.getElementById('feedbackForm');
        const submitButton = document.getElementById('submitButton');
        let isFormValid = true;

        // 1. 检查所有文本输入字段和文本域
        const requiredFields = [
            'firstName', 'lastName', 'emailId', 'phoneNumber', 'zipcode', 'comments'
        ];

        requiredFields.forEach(id => {
            const field = document.getElementById(id);
            if (!field || field.value.trim() === '' || field.classList.contains('error-input')) {
                isFormValid = false;
            }
        });

        // 2. 特殊检查 1: 称谓 (Radio Buttons)
        const titleRadios = form.elements['title'];
        let isTitleChecked = Array.from(titleRadios).some(radio => radio.checked);
        if (!isTitleChecked) {
            isFormValid = false;
            // 修正：将错误提示改为英文
            document.getElementById('titleError').textContent = 'Please select a title.';
            document.getElementById('titleError').style.display = 'block';
        } else {
            document.getElementById('titleError').style.display = 'none';
        }

        // 3. 特殊检查 2: How did you hear (Checkboxes)
        const sourceCheckboxes = form.elements['source'];
        let isSourceChecked = Array.from(sourceCheckboxes).some(checkbox => checkbox.checked);
        if (!isSourceChecked) {
            isFormValid = false;
            // 修正：将错误提示改为英文
            document.getElementById('sourceError').textContent = 'Please select at least one source.';
            document.getElementById('sourceError').style.display = 'block';
        } else {
            document.getElementById('sourceError').style.display = 'none';
        }
        
        // 4. 特殊检查 3: Reason Select (下拉列表)
        const reasonSelect = document.getElementById('reasonSelect');
        if (reasonSelect && !validateSelect(reasonSelect)) {
            isFormValid = false;
        }

        // 5. 特殊检查 4: 动态生成的必填文本字段
        const dynamicCheckbox = document.getElementById('dynamicCheckbox');
        const dynamicTextField = document.getElementById('dynamicTextField');
        
        if (dynamicCheckbox && dynamicCheckbox.checked) {
            // 如果复选框被选中，则文本字段必须存在且有效
            if (!dynamicTextField || dynamicTextField.value.trim() === '' || dynamicTextField.classList.contains('error-input')) {
                isFormValid = false;
            }
        }
        
        // 最终决定提交按钮的状态
        submitButton.disabled = !isFormValid;
    }


    // =========================================================================
    // 提交和初始化逻辑 (要求 10, 11)
    // =========================================================================
    
    /**
     * 清空表单字段 (要求 11)
     */
     function clearFormFields(form) {
        form.reset(); 
        
        // 手动清除错误高亮和动态内容
        document.querySelectorAll('.error-input').forEach(el => el.classList.remove('error-input'));
        document.querySelectorAll('.error-text').forEach(el => el.style.display = 'none');
        document.getElementById('dynamicContentArea').innerHTML = '';
        
        // 重置 Street Address 2 计数器
        document.getElementById('address2Counter').textContent = '0/50 characters used';
        
        // 确保提交按钮被禁用
        document.getElementById('submitButton').disabled = true;

        // 重新运行验证来清理所有状态
        validateForm(); 
    }

    /**
     * 创建并显示结果表格 (要求 10)
     */
    function displayResultsTable(submissions) {
        const container = document.getElementById('resultsTableContainer');
        if (!container || submissions.length === 0) return;

        let tableHtml = '<h3>Previous Submissions</h3>';
        
        const allKeys = new Set();
        submissions.forEach(sub => {
            // 捕获所有键，包括动态字段
            Object.keys(sub).forEach(key => allKeys.add(key));
        });
        
        // 定义一个显示顺序 (使用字段的原始 name/id)
        const customOrder = [
             'title', 'firstName', 'lastName', 'emailId', 'phoneNumber', 'streetAddress2', 'zipcode', 'source', 
             'reasonSelect', 'dynamicCheckbox', 'dynamicTextField', 'text' 
        ];
        
        // 过滤并排序表头
        const headers = customOrder.filter(key => allKeys.has(key));


        tableHtml += '<table border="1" style="width:100%; border-collapse: collapse;">';
        
        // 表头
        tableHtml += '<tr>';
        headers.forEach(key => {
            // 格式化表头名称，使其更具可读性
            let displayKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            if (displayKey === 'Text') displayKey = 'Comments';
            if (displayKey === 'Source') displayKey = 'How did you hear';
            if (displayKey === 'ReasonSelect') displayKey = 'Reason For Feedback';
            if (displayKey === 'DynamicCheckbox') displayKey = 'Dynamic Checkbox Enabled';
            if (displayKey === 'DynamicTextField') displayKey = 'Dynamic Detail';

            tableHtml += `<th style="padding: 5px;">${displayKey}</th>`;
        });
        tableHtml += '</tr>';

        // 行数据
        submissions.forEach((sub, index) => {
            tableHtml += `<tr style="background-color: ${index % 2 === 0 ? '#f2f2f2' : 'white'};">`;
            headers.forEach(key => {
                let value = sub[key] !== undefined ? sub[key] : 'N/A';
                
                // 处理数组值 (如 How did you hear)
                if (Array.isArray(value)) {
                    value = value.join(', ');
                }
                
                tableHtml += `<td style="padding: 5px; word-break: break-word;">${value}</td>`;
            });
            tableHtml += '</tr>';
        });

        tableHtml += '</table>';

        container.innerHTML = tableHtml;
    }


    /**
     * 处理表单提交
     */
    document.getElementById('feedbackForm').onsubmit = function(event) {
        event.preventDefault(); // 阻止默认提交行为
        
        const form = event.target;
        
        // 1. 验证最终状态
        validateForm();
        if (form.elements['submitButton'].disabled) {
            alert('Please fill in all required fields and correct errors.');
            return; 
        }

        // 2. 收集数据
        const data = {};
        const elements = form.elements;
        
        // 遍历所有有名元素
        for (let i = 0; i < elements.length; i++) {
            const element = elements[i];
            const name = element.name;
            
            if (name && element.type !== 'submit' && element.type !== 'reset') { 
                if (element.type === 'radio') {
                    if (element.checked) {
                        data[name] = element.value;
                    }
                } else if (element.type === 'checkbox' && name === 'source') {
                    if (element.checked) {
                         // 收集所有选中的 source
                        if (!data[name]) data[name] = [];
                        data[name].push(element.value);
                    }
                } else if (element.tagName === 'SELECT' || element.type === 'text' || element.tagName === 'TEXTAREA') {
                    data[name] = element.value.trim();
                }
            }
        }
        
        // 捕获动态字段的值 (使用 id 作为键值)
        const dynamicCheckbox = document.getElementById('dynamicCheckbox');
        const dynamicTextField = document.getElementById('dynamicTextField');
        
        // 确保使用统一的键名，方便表格展示
        data['reasonSelect'] = document.getElementById('reasonSelect').value;
        data['text'] = document.getElementById('comments').value.trim(); 

        if (dynamicCheckbox) {
             data['dynamicCheckbox'] = dynamicCheckbox.checked ? 'Yes' : 'No';
             data['dynamicTextField'] = dynamicTextField ? dynamicTextField.value.trim() : 'N/A';
        } else {
             data['dynamicCheckbox'] = 'N/A';
             data['dynamicTextField'] = 'N/A';
        }
        
        // Street address 2 非强制，如果为空则保持为空
        data['streetAddress2'] = data['streetAddress2'] || '';


        // 3. 存储数据 (要求 10 - 捕获之前的数据)
        previousSubmissions.push(data);
        
        // 4. 显示 HTML Table (要求 10)
        displayResultsTable(previousSubmissions);
        
        // 5. 清空表单 (要求 11)
        clearFormFields(form);
    };

    /**
     * 页面加载时，对所有字段执行初始验证
     */
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('submitButton').disabled = true;

        const fieldsToInit = ['firstName', 'lastName', 'emailId', 'phoneNumber', 'zipcode', 'comments', 'reasonSelect', 'streetAddress2'];
        fieldsToInit.forEach(id => {
            const field = document.getElementById(id);
            if (field) {
                if (field.id === 'phoneNumber') {
                    phoneMaskAndValidate(field); 
                } else if (field.id === 'reasonSelect') {
                    validateSelect(field); 
                } else {
                    // 尝试从 onkeyup 属性中提取参数并执行验证
                    const onkeyupAttr = field.getAttribute('onkeyup');
                    if (onkeyupAttr) {
                        const regexMatch = onkeyupAttr.match(/\/(.*?)\//);
                        const lengthMatches = onkeyupAttr.match(/\d+/g);
                        
                        const regex = regexMatch ? new RegExp(regexMatch[1]) : null;
                        // 确保 lengthMatches 至少有 2 个数字
                        const minLen = lengthMatches && lengthMatches.length >= 2 ? parseInt(lengthMatches[0]) : 0;
                        const maxLen = lengthMatches && lengthMatches.length >= 2 ? parseInt(lengthMatches[1]) : 0;
                        
                        // Street Address 2 是唯一非必填字段
                        const isRequired = field.id !== 'streetAddress2';

                        validateField(field, regex, minLen, maxLen, isRequired);
                    }
                }
            }
        });
        
        validateForm();
    });

 </script>

 </body>
</html>